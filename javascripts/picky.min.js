Array.prototype.index=function(a){for(var b=0,h=this.length;b<h;b++)if(this[b]==a)return b;return null};Array.prototype.include=function(a){return this.index(a)!==null};Array.prototype.remove=function(a){this.splice(a,1);return this};Array.prototype.compare=function(a){return this.join("")==a.join("")};Array.prototype.each=function(a){for(var b=0,h=this.length;b<h;b++)a(b,this[b]);return this};var dictionary={common:{join:{de:"und",fr:"et",it:"e",en:"and",ch:"und"},"with":{de:"mit",fr:"avec",it:"con",en:"with",ch:"mit"},of:{de:"von",fr:"de",it:"di",en:"of",ch:"vo"},to:{de:"bis",fr:"\u00e0",it:"alla",en:"to",ch:"bis"}},results:{addination:{more:{de:"Weitere Resultate",fr:"Autres r\u00e9sultats",it:"Altri risultati",en:"More results",ch:"Mee Resultaat"}},header:{de:"Ergebnisse",fr:"R\u00e9sultats",it:"Risultati",en:"Results",ch:"Erg\u00e4bnis"}}},t=function(a){for(var b=PickyI18n.locale||
"en",h=a.split(".").concat(b),g=dictionary,e=0,n=h.length;e<n;e++){g=g[h[e]];if(g==undefined){g="Translation missing: "+a+"."+b;break}}return g};function Allocation(a,b,h,g,e,n){var p=this;this.type=a;this.weight=b;this.count=h;this.combination=g;this.ids=e||[];this.entries=this.rendered=n;this.isType=function(s){return s==p.type}}function Allocations(a){this.allocations=[];for(var b=0,h=a.length;b<h;b++){var g=a[b];this.allocations.push(new Allocation(g[0],g[1],g[2],g[3],g[4],g[5]))}this.length=this.allocations.length;this.remove=function(e){this.allocations.splice(e,1)};this.each=function(e){this.allocations.each(e)}}
function PickyData(a){var b=a.total,h=a.duration,g=a.offset,e=new Allocations(a.allocations||[]);this.original_hash=a;this.total=b;this.duration=h;this.offset=g;this.allocations=e;this.renderedAmount=function(){var n=0;e.each(function(p,s){n+=s.rendered.length});return n};this.isEmpty=function(){return b==0}};var PickyView=function(a,b){var h=b.showResultsLimit||10,g=b.input,e=b.reset,n=b.button,p=b.counter,s=b.dashboard,w=b.moreSelector,x=b.results,y=b.noResults,j=new PickyAddination(this,x),r=new PickyAllocationsCloud(this,b),d=new PickyResultsRenderer(j,b),f=function(){e.fadeTo(166,1)},k=function(){r.hide();x.empty();y.hide()},o=function(i){g.val(i);e.fadeTo(166,0);q("empty");p.empty();k()},m=function(){return g.val()};this.text=m;var u=function(i){p.text(i);i>0&&i<=5&&p.fadeTo("fast",0.5).fadeTo("fast",
1)},c=function(i){if(i.isEmpty())return"none";if(i.total>h&&i.allocations.length>1)return"support";return"ok"},q=function(i){s.attr("class","dashboard "+i)};this.insert=function(i){g.val(i);g.select()};this.fullResultsCallback=function(i){q(c(i));if(i.isEmpty()){k();u(0);y.show();f()}else if(i.total>h&&i.allocations.length>1){k();f();r.show(i);u(i.total)}else if(i.offset==0){k();u(i.total);d.render(i);x.show();f();g.focus()}else{var v=$(w).position().top;j.remove();d.render(i);$("body").animate({scrollTop:v-
12},500)}};this.liveResultsCallback=function(i){q(c(i));u(i.total)};this.allocationChosen=function(i){i=i.data.query;a.insert(i);a.allocationChosen(i)};this.addinationClicked=function(i){a.addinationClicked(m(),i)};(function(){g.keyup(function(i){if(m()==""){o();a.searchTextCleared()}else{a.searchTextEntered(m(),i);f()}});p.click(function(){m()==""||a.searchButtonClicked(m())});n.click(function(){m()==""||a.searchButtonClicked(m())});e.click(function(){o("");a.clearButtonClicked();g.focus()})})();
g.focus()};var PickyBackend=function(a){var b=function(h,g,e){var n=e||{};n=$.extend({query:h},e);$.getJSON(a,n,function(p){g&&g(new PickyData(p))})};this.search=function(h,g,e,n){b(h,function(p){g&&g(n,p)},e)}},LiveBackend=function(a){var b=a.live||alert("A live backend path must be provided."),h=new PickyBackend(b);this.search=function(g,e,n,p){p=p||{};latestRequestTimestamp=new Date;p.live=latestRequestTimestamp;n=$.extend({ids:a.liveResults||0,offset:0},n);h.search(g,function(s,w){if(!s.live||s.live==latestRequestTimestamp)e&&
e(w)},n,p)}},FullBackend=function(a){var b=a.full||alert("A full backend path must be provided."),h=new PickyBackend(b);this.search=function(g,e,n,p){p=p||{};latestRequestTimestamp=new Date;p.full=latestRequestTimestamp;n=$.extend({ids:a.fullResults||20,offset:0},n);h.search(g,function(s,w){if(!s.full||s.full==latestRequestTimestamp)e&&e(w)},n,p)}};var PickyController=function(a){var b=new PickyView(this,a),h=a.backends,g=a.beforeInsert||function(){},e=a.before||function(){},n=a.success||function(){},p=a.after||function(){},s=a.liveRendered||false,w=a.liveSearchInterval||180,x,y=function(c){return(c=c&&c.match(/q=([^&]+)/))&&decodeURIComponent(c[1]).replace(/\+/g," ").replace(/#/g,"")||""};this.extractQuery=y;var j=function(){var c=window.History&&window.History.getState();return y(c&&c.url)};this.lastFullQuery=j;var r=function(c,q,i,v){q=e(q,
v)||q;x=[c,q,i,v];var z=q;if(z!=j()){z="?q="+escape(z).replace(/\*/g,"%2A");window.History&&window.History.getState()&&window.History.pushState&&window.History.pushState(null,null,z)}(c=h[c])&&c.search(q,i,v)};this.resend=function(){x&&r.apply(this,x)};var d=function(c,q){c=n(c,q)||c;b.fullResultsCallback(c);p(c,q)},f=function(c,q){clearInterval(o);r("full",c,d,q||{})};a=function(c,q){c=n(c,q)||c;b.liveResultsCallback(c);p(c,q)};var k=s?d:a,o,m=function(){var c=b.text();r("live",c,k,{});clearInterval(o)};
o=setInterval(m,w);clearInterval(o);var u=function(c,q,i){c=g(c)||c;b.insert(c);i&&f(c,q)};this.insert=u;this.clearButtonClicked=function(){clearInterval(o)};this.searchTextCleared=function(){clearInterval(o)};this.searchTextEntered=function(c,q){if($.inArray(q.keyCode,[0,8,13,32,46,48,49,50,51,52,53,54,55,56,57,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90])>-1)if(q.keyCode==13)f(c);else{clearInterval(o);o=setInterval(m,w)}};this.searchButtonClicked=function(c){f(c)};
this.allocationChosen=function(c){f(c)};this.addinationClicked=function(c,q){f(c,{offset:q.data.offset})};window.History&&window.History.Adapter.bind(window,"statechange",function(){var c=window.History.getState();(c=y(c.url))&&c!=(x.length>1&&x[1])&&u(c,{},true)})};var Localization={},PickyI18n={};$(function(){PickyI18n.locale=$("html").attr("lang").split("-")[0]||"en"});
var PickyClient=function(a){Localization.qualifiers=a.qualifiers||{};Localization.explanations=a.explanations||{};Localization.choices=a.choices||{};Localization.explanation_delimiters={de:"und",fr:"et",it:"e",en:"and",ch:"und"};var b=a.backends;if(b){b.live||alert("Both a full and live backend must be provided.");b.full||alert("Both a full and live backend must be provided.")}else a.backends={live:new LiveBackend(a),full:new FullBackend(a)};b=a.enclosingSelector||"#picky";a.input=$(a.inputSelector||
b+" input.query");a.reset=$(a.resetSelector||b+" div.reset");a.button=$(a.buttonSelector||b+" input.search_button");a.counter=$(a.counterSelector||b+" div.status");a.dashboard=$(a.dashboardSelector||b+" .dashboard");a.results=$(a.resultsSelector||b+" div.results");a.noResults=$(a.noResultsSelector||b+" .no_results");a.moreSelector=a.moreSelector||b+" div.results div.addination:last";a.allocations=$(a.allocationsSelector||b+" .allocations");a.shownAllocations=a.allocations.find(".shown");a.showMoreAllocations=
a.allocations.find(".more");a.hiddenAllocations=a.allocations.find(".hidden");a.maxSuggestions=a.maxSuggestions||3;a.results=$(a.resultsSelector||b+" div.results");a.resultsDivider=a.resultsDivider||"";a.noAsterisks=a.noAsterisks||[];a.wrapResults=a.wrapResults||'<ol class="results"></ol>';var h=a.controller&&new a.controller(a)||new PickyController(a);var g=this.insert=function(e,n,p){h.insert(e,n||{},p||true)};this.resend=h.resend;this.insertFromURL=function(e){if(e&&e!="")g(e);else(e=h.lastFullQuery())&&
g(e)}};var PickyAddination=function(a,b){this.remove=function(){b.find(".addination").remove()};this.render=function(h){var g=h.total,e,n=h.renderedAmount();e=h.offset+n;n=e+n;h=h.total;if(h<n)n=h;e={offset:e,start:e+1,end:n};if(e.offset<g){g=$("<div class='addination'>"+t("results.addination.more")+"</div>");g.bind("click",{offset:e.offset},a.addinationClicked);return g}else return""}};var PickyResultsRenderer=function(a,b){var h=b.results,g=b.resultsDivider,e=b.wrapResults,n=b.noAsterisks,p=function(j){var r=j[j.length-1];j=j.slice(0,j.length-1);if(j==[])j=[j];if(!n.include(r[0]))if(r[1].match(/[^\*~]$/))r[1]+="*";j.push(r);return j},s=function(j){for(var r=Localization.explanations&&Localization.explanations[PickyI18n.locale]||{},d=[],f,k=0,o=j.length;k<o;k++){f=j[k];var m=f[0];m=r[m]||m;d.push([m,f[1]])}return d},w=function(j,r){return[j.replace(/([\w\s\u00c4\u00e4\u00d6\u00f6\u00dc\u00fc\u00e9\u00e8\u00e0]+)/,
"<strong>$1</strong>"),r].join(" ")},x=function(j,r){var d=Localization.explanation_delimiters[PickyI18n.locale],f=s(p(r)),k="",o=[];f=$.map(f,function(m){var u=m[0];m=m[1];if(k==""||u==k){m=m.replace(/[\w,]+:(.+)/,"$1");o.push(m);k=u}else{var c=w(k,o.join(" "));o=[];o.push(m);k=u;return c}});f.push(w(k,o.join(" ")));f=f.join(" "+d+" ");return'<span class="explanation">'+j+" "+f+"</span>"},y=function(j,r){var d='<div class="header">';d+=x(r.type,r.combination);if(j.offset>0)d+='<div class="tothetop"><a href="#" onclick="javascript:$(\'body\').animate({scrollTop: 0}, 500);">&uarr;</a></div>';
return d};this.render=function(j){j.allocations.each(function(r,d){if(d.entries.length>0){h.append(y(j,d)).append(d.entries.join(g));h.children("li").wrapAll(e)}});h.append(a.render(j))}};function AllocationRenderer(a,b){function h(d){var f={},k={},o=[],m;m=0;for(l=d.length;m<l;m++){var u=d[m][0];if(u in f){f[u]=f[u]+" "+d[m][1];o.push(m)}else{f[u]=d[m][1];k[m]=u}}for(m in k)d[m][1]=f[k[m]];for(m=o.length-1;m>=0;m--)d.remove(o[m]);return d}function g(d){return $.map(d,function(f,k){return"%"+(k+1)+"$s"}).join(" ")}function e(d){if(d.length==0)return"";var f=d=h(d);f.sort(function(v,z){return v[0]<z[0]?-1:1});for(var k=[],o=0,m=f.length;o<m;o++)k.push(f[o][0]);var u=k.length==1,c=j[k]||
(j[k]=g(k));if($.type(c)==="string"){j[k]={format:c};c=j[k]}var q=1,i=c.format;$.each(d,function(v,z){var A=z[0],B=z[2];if(c.filter)B=c.filter(B);A=x[A]||A;if(u&&!(c&&c.ignoreSingle))return i=B+"&nbsp;("+A+")";i=i.replace(RegExp("%"+q+"\\$s","g"),B);q+=1;return q});return i}function n(d){for(var f=[],k=0,o=y.length;k<o;k++)f.push([]);f.push([]);k=0;for(o=d.length;k<o;k++){for(var m=d[k],u=m[0],c=false,q=0,i=y.length;q<i;q++)if(y[q].include(u)){f[q].push(m);c=true;break}c||f[f.length-1].push(m)}var v;
for(d=f.length-1;d>=0;d--){v=f[d];if(v.length>0)break}v=v[v.length-1];r.include(v[0])||(v[1]+="...");return $.map(f,function(z){return e(z)})}function p(d){var f=[],k,o;for(o in d){k=d[o][0];k=w[k]||k;f[o]=k+":"+d[o][2]}return f.join(" ")}var s=PickyI18n.locale,w=Localization.qualifiers&&Localization.qualifiers[s]||{},x=Localization.explanations&&Localization.explanations[s]||{},y=b.groups||[],j=Localization.choices&&Localization.choices[s]||{};this.explanation=this.query=this.text="";var r=["street_number",
"zipcode"];this.contract=h;this.rendered=e;this.groupify=n;this.querify=p;this.render=function(d){var f=d.combination,k=d.count;d=p(f);f=n(f).join(" ");f=$('<li><div class="text">'+f+'</div><div class="count">'+k+"</div></li>");f.bind("click",{query:d},a);return f}};var PickyAllocationsCloud=function(a,b){var h=b.allocations,g=b.shownAllocations,e=b.showMoreAllocations,n=b.hiddenAllocations,p=b.maxSuggestions,s=function(){h.hide()},w=new AllocationRenderer(function(j){s();a.allocationChosen(j)},b),x=function(j){var r=[];j.each(function(d,f){r.push(w.render(f))});return r},y=function(j){if(j.length==0)return h.hide();g.empty();e.hide();n.empty().hide();if(j.length>p){$.each(j.slice(0,p-1),function(r,d){g.append(d)});$.each(j.slice(p-1),function(r,d){n.append(d)});
e.show()}else $.each(j,function(r,d){g.append(d)});return h.show()};e.click(function(){e.hide();n.show()});this.hide=s;this.show=function(j){y(x(j.allocations));h.show()}};
